{% extends "base.html" %}

{% block title %}Signers Management{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
  <div class="flex items-center justify-between mb-2">
    <div>
      <div class="text-sm text-gray-500">Dashboard / <span class="text-itpark-dark">Signers</span></div>
      <h1 class="text-2xl font-bold text-itpark-dark">Signers</h1>
    </div>
    <button onclick="openModal('addSignerModal')" class="bg-itpark-green hover:bg-itpark-green-dark text-white px-4 py-2 rounded">+ Add Signer</button>
  </div>
  {% if msg %}
  <div class="mb-4 p-3 bg-green-100 text-green-700 rounded">{{ msg }}</div>
  {% endif %}
  {% if error %}
  <div class="mb-4 p-3 bg-red-100 text-red-700 rounded">{{ error }}</div>
  {% endif %}

  <!-- Filters -->
  <div class="bg-white rounded shadow p-4 mb-4">
    <form onsubmit="event.preventDefault(); filterSigners();" class="grid grid-cols-1 md:grid-cols-4 gap-3">
      <div>
        <label class="block text-sm">Region ID</label>
        <input type="number" id="filter_region_id" class="border p-2 rounded w-full" placeholder="e.g. 1">
      </div>
      <div>
        <label class="block text-sm">Position</label>
        <input type="text" id="filter_position" class="border p-2 rounded w-full" placeholder="e.g. Regional Director">
      </div>
      <div class="flex items-end">
        <button type="submit" class="bg-itpark-green hover:bg-itpark-green-dark text-white px-4 py-2 rounded">Filter</button>
      </div>
    </form>
  </div>

  <!-- Table -->
  <div class="overflow-x-auto bg-white shadow rounded">
    <table class="min-w-full">
      <thead class="bg-itpark-dark text-white">
        <tr>
          <th class="px-4 py-2 text-left">ID</th>
          <th class="px-4 py-2 text-left">Name</th>
          <th class="px-4 py-2 text-left">Position</th>
          <th class="px-4 py-2 text-left">Email</th>
          <th class="px-4 py-2 text-left">Phone</th>
          <th class="px-4 py-2 text-left">Region</th>
          <th class="px-4 py-2 text-left">Order</th>
          <th class="px-4 py-2 text-left">Status</th>
          <th class="px-4 py-2 text-left">Actions</th>
        </tr>
      </thead>
      <tbody id="signersBody">
        {% for s in signers %}
        <tr class="border-b hover:bg-gray-50">
          <td class="px-4 py-2">{{ s.id }}</td>
          <td class="px-4 py-2">{{ s.name }}</td>
          <td class="px-4 py-2">{{ s.position }}</td>
          <td class="px-4 py-2">{{ s.email }}</td>
          <td class="px-4 py-2">{{ s.phone or '-' }}</td>
          <td class="px-4 py-2">{{ s.region_id or '-' }}</td>
          <td class="px-4 py-2">{{ s.signing_order }}</td>
          <td class="px-4 py-2">{{ s.status }}</td>
          <td class="px-4 py-2">
            <button class="text-itpark-green edit-signer-btn" 
                    data-id="{{ s.id }}"
                    data-name="{{ s.name }}"
                    data-position="{{ s.position }}"
                    data-email="{{ s.email }}"
                    data-phone="{{ s.phone or '' }}"
                    data-region-id="{{ s.region_id or '' }}"
                    data-signing-order="{{ s.signing_order }}"
                    data-status="{{ s.status }}">Edit</button>
            |
            <form method="post" action="/admin/signers/delete" class="inline" onsubmit="return confirm('Delete signer?')">
              <input type="hidden" name="id" value="{{ s.id }}">
              <button type="submit" class="text-red-600">Delete</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Add Signer Modal -->
  <div id="addSignerModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white rounded-lg p-6 w-96">
      <h3 class="text-lg font-semibold mb-4 text-itpark-dark">Add Signer</h3>
      <form method="POST" action="/admin/signers">
        <div class="space-y-3">
          <div>
            <label class="block text-sm">Full Name</label>
            <input type="text" name="name" class="border p-2 w-full rounded" required>
          </div>
          <div>
            <label class="block text-sm">Position</label>
            <select name="position" class="border p-2 w-full rounded">
              <option>Regional Director</option>
              <option>Main Manager</option>
              <option>Accountant</option>
              <option>Lawyer</option>
              <option>General Director</option>
            </select>
          </div>
          <div>
            <label class="block text-sm">Email</label>
            <input type="email" name="email" class="border p-2 w-full rounded" required>
          </div>
          <div>
            <label class="block text-sm">Phone</label>
            <input type="text" name="phone" class="border p-2 w-full rounded" placeholder="+998...">
          </div>
          <div>
            <label class="block text-sm">Region ID (optional)</label>
            <input type="number" name="region_id" class="border p-2 w-full rounded">
          </div>
          <div>
            <label class="block text-sm">Signing Order</label>
            <input type="number" name="signing_order" class="border p-2 w-full rounded" required>
          </div>
          <div>
            <label class="block text-sm">Status</label>
            <select name="status_value" class="border p-2 w-full rounded">
              <option value="active">active</option>
              <option value="inactive">inactive</option>
            </select>
          </div>
        </div>
        <div class="flex justify-end gap-2 mt-4">
          <button type="button" onclick="closeModal('addSignerModal')" class="px-4 py-2 border rounded">Cancel</button>
          <button type="submit" class="bg-itpark-green hover:bg-itpark-green-dark text-white px-4 py-2 rounded">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Signer Modal -->
  <div id="editSignerModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white rounded-lg p-6 w-96">
      <h3 class="text-lg font-semibold mb-4 text-itpark-dark">Edit Signer</h3>
      <form method="POST" action="/admin/signers/update">
        <input type="hidden" name="id" id="editSignerId">
        <div class="space-y-3">
          <div>
            <label class="block text-sm">Full Name</label>
            <input type="text" name="name" id="editSignerName" class="border p-2 w-full rounded" required>
          </div>
          <div>
            <label class="block text-sm">Position</label>
            <select name="position" id="editSignerPosition" class="border p-2 w-full rounded">
              <option>Regional Director</option>
              <option>Main Manager</option>
              <option>Accountant</option>
              <option>Lawyer</option>
              <option>General Director</option>
            </select>
          </div>
          <div>
            <label class="block text-sm">Email</label>
            <input type="email" name="email" id="editSignerEmail" class="border p-2 w-full rounded" required>
          </div>
          <div>
            <label class="block text-sm">Phone</label>
            <input type="text" name="phone" id="editSignerPhone" class="border p-2 w-full rounded" placeholder="+998...">
          </div>
          <div>
            <label class="block text-sm">Region ID (optional)</label>
            <input type="number" name="region_id" id="editSignerRegion" class="border p-2 w-full rounded">
          </div>
          <div>
            <label class="block text-sm">Signing Order</label>
            <input type="number" name="signing_order" id="editSignerOrder" class="border p-2 w-full rounded" required>
          </div>
          <div>
            <label class="block text-sm">Status</label>
            <select name="status_value" id="editSignerStatus" class="border p-2 w-full rounded">
              <option value="active">active</option>
              <option value="inactive">inactive</option>
            </select>
          </div>
        </div>
        <div class="flex justify-end gap-2 mt-4">
          <button type="button" onclick="closeModal('editSignerModal')" class="px-4 py-2 border rounded">Cancel</button>
          <button type="submit" class="bg-itpark-green hover:bg-itpark-green-dark text-white px-4 py-2 rounded">Update</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  function openModal(id){ document.getElementById(id).classList.remove('hidden'); }
  function closeModal(id){ document.getElementById(id).classList.add('hidden'); }
  function prepareEditSigner(id, name, position, email, phone, region_id, order, status) {
    document.getElementById('editSignerId').value = id;
    document.getElementById('editSignerName').value = name;
    document.getElementById('editSignerPosition').value = position;
    document.getElementById('editSignerEmail').value = email;
    document.getElementById('editSignerPhone').value = phone || '';
    document.getElementById('editSignerRegion').value = region_id || '';
    document.getElementById('editSignerOrder').value = order;
    document.getElementById('editSignerStatus').value = status;
    openModal('editSignerModal');
  }
  
  // Event delegation for edit buttons
  document.addEventListener('DOMContentLoaded', function() {
    document.addEventListener('click', function(e) {
      if (e.target.classList.contains('edit-signer-btn')) {
        const btn = e.target;
        prepareEditSigner(
          btn.dataset.id,
          btn.dataset.name,
          btn.dataset.position,
          btn.dataset.email,
          btn.dataset.phone,
          btn.dataset.regionId,
          btn.dataset.signingOrder,
          btn.dataset.status
        );
      }
    });
  });
  function filterSigners(){
    const region = document.getElementById('filter_region_id').value;
    const position = document.getElementById('filter_position').value;
    let url = '/signers?';
    const params = [];
    if (region) params.push('region_id=' + encodeURIComponent(region));
    if (position) params.push('position=' + encodeURIComponent(position));
    url += params.join('&');
    fetch(url).then(r=>r.json()).then(list=>{
      const tbody = document.getElementById('signersBody');
      tbody.innerHTML = list.map(s=>`
        <tr class="border-b hover:bg-gray-50">
          <td class="px-4 py-2">${s.id}</td>
          <td class="px-4 py-2">${s.name}</td>
          <td class="px-4 py-2">${s.position}</td>
          <td class="px-4 py-2">${s.email}</td>
          <td class="px-4 py-2">${s.phone || '-'}</td>
          <td class="px-4 py-2">${s.region_id || '-'}</td>
          <td class="px-4 py-2">${s.signing_order}</td>
          <td class="px-4 py-2">${s.status}</td>
          <td class="px-4 py-2">
            <button class="text-itpark-green edit-signer-btn" 
                    data-id="${s.id}"
                    data-name="${s.name}"
                    data-position="${s.position}"
                    data-email="${s.email}"
                    data-phone="${s.phone || ''}"
                    data-region-id="${s.region_id || ''}"
                    data-signing-order="${s.signing_order}"
                    data-status="${s.status}">Edit</button>
          </td>
        </tr>
      `).join('');
    });
  }
</script>
{% endblock %}


